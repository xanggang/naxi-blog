(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{441:function(t,s,e){t.exports=e.p+"assets/img/10.1ca44304.jpg"},481:function(t,s,e){t.exports=e.p+"assets/img/1.16cdafdc.jpg"},482:function(t,s,e){t.exports=e.p+"assets/img/2.0191411a.jpg"},483:function(t,s,e){t.exports=e.p+"assets/img/3.82fdfebb.jpg"},484:function(t,s,e){t.exports=e.p+"assets/img/4.acdadea5.jpg"},485:function(t,s,e){t.exports=e.p+"assets/img/5.51d63ab2.jpg"},486:function(t,s,e){t.exports=e.p+"assets/img/6.fa15485c.jpg"},487:function(t,s,e){t.exports=e.p+"assets/img/7.83abf091.jpg"},488:function(t,s,e){t.exports=e.p+"assets/img/8.e4562996.jpg"},489:function(t,s,e){t.exports=e.p+"assets/img/9.f3650338.jpg"},502:function(t,s,e){"use strict";e.r(s);var n=e(4),a=Object(n.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"使用jenkins自动构建和部署web项目"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#使用jenkins自动构建和部署web项目"}},[t._v("#")]),t._v(" 使用jenkins自动构建和部署web项目")]),t._v(" "),n("h3",{attrs:{id:"准备工作"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#准备工作"}},[t._v("#")]),t._v(" 准备工作")]),t._v(" "),n("p",[t._v("1，正确安装jenkins工具")]),t._v(" "),n("p",[t._v('2，登陆github， 点击右上角头像，依次点击Settings -》 Developer settings -》 Personal access tokens -》 Generate new token，\n选择repo和admin:repo_hook， 然后点击 "Generate tocken"，保存好这个token， 离开这个页面之后就找不回来了哦')]),t._v(" "),n("p",[n("img",{attrs:{src:e(481),alt:"An image"}})]),t._v(" "),n("p",[t._v("3，进入jenkins， 系统管理-系统配置， 找到Github服务器一栏，api-url填写"),n("code",[t._v("https://api.github.com")]),t._v("，\n"),n("img",{attrs:{src:e(482),alt:"An image"}})]),t._v(" "),n("p",[t._v("4，在凭据一栏， 点击添加，选择Secret Text， Secret添加刚才生成的token，id和描述随便填写， 填完之后点击连接测试\n提示Credentials verified for user就配置好了\n"),n("img",{attrs:{src:e(483),alt:"An image"}})]),t._v(" "),n("p",[t._v("5，点击系统管理-管理用户-选择当前登陆的用户， 选择设置，在API Token一栏选择生成token， 这个token接下来会用到，\n"),n("img",{attrs:{src:e(484),alt:"An image"}})]),t._v(" "),n("h3",{attrs:{id:"创建项目"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建项目"}},[t._v("#")]),t._v(" 创建项目")]),t._v(" "),n("p",[t._v("1，在首页新建项目， 选择构建自由风格的软件项目")]),t._v(" "),n("p",[t._v("2，点开配置， 在源码管理选择git， 输入github中项目的的https地址")]),t._v(" "),n("p",[t._v("3，在Credentials中点击后面的添加-jenkins，选择刚加入的凭证\n"),n("img",{attrs:{src:e(485),alt:"An image"}})]),t._v(" "),n("p",[t._v("4，根据需要选择需要触发的分支")]),t._v(" "),n("p",[t._v("5，在构建触发器中选择触发远程构建， 填写随机的身份验证令牌, 这个令牌是项目的令牌， 不要记混了")]),t._v(" "),n("p",[n("img",{attrs:{src:e(486),alt:"An image"}}),t._v("\n这里可以保存一下")]),t._v(" "),n("p",[t._v("6，回到github的项目中，选择对应的项目， settings -》 webhook -》 Add webhook，\n在Payload URL中填写"),n("code",[t._v("http://${user}:${userToken}@${url}/job/${jobName}/build?token=${jobToken}")]),t._v(",\nSecret中也填写jobToken，点击保存\n"),n("img",{attrs:{src:e(487),alt:"An image"}})]),t._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",[t._v("注意解释一下：\n"),n("code",[t._v("http://${user}:${userToken}@${url}/job/${jobName}/build?token=${jobToken}")])]),t._v(" "),n("ul",[n("li",[t._v("这里的user是jenkins的账号，")]),t._v(" "),n("li",[t._v("userToken是上面准备工作中生成的账号的token")]),t._v(" "),n("li",[t._v("url 是jenkins的地址")]),t._v(" "),n("li",[t._v("jobName 是jenkins项目的名称")]),t._v(" "),n("li",[t._v("jobToken 是在第5步中项目的token")])]),t._v(" "),n("p",[t._v("这个地址在浏览器中也可以直接触发构建， 401和403一般都是token配置错误")])]),t._v(" "),n("p",[t._v("保存之后会自动生成一次请求， 然后可以在这里测试连接\n"),n("img",{attrs:{src:e(488),alt:"An image"}})]),t._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",[t._v("如果所有配置都正确还是出现401或者403， 可以去全局安全策略里改一下授权策略\n"),n("img",{attrs:{src:e(489),alt:"An image"}})])]),t._v(" "),n("h3",{attrs:{id:"编写构建命令"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#编写构建命令"}},[t._v("#")]),t._v(" 编写构建命令")]),t._v(" "),n("p",[t._v("不同的项目情况不同， 这里我分享两种情况")]),t._v(" "),n("h4",{attrs:{id:"使用docker构建node服务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#使用docker构建node服务"}},[t._v("#")]),t._v(" 使用docker构建node服务")]),t._v(" "),n("p",[t._v("在node项目内准备好dockerfile文件，")]),t._v(" "),n("div",{staticClass:"language-dockerfile extra-class"},[n("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 设置基础镜像,如果本地没有该镜像，会从Docker.io服务器pull镜像")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# node:alpine是精简过的node镜像")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" node"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("alpine\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WORKDIR")]),t._v(" /app\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" package.json /app/\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" npm install "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("g cnpm "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("registry=https"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//registry.npm.taobao.org\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" cnpm install\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" . /app/\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 暴露容器端口")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("EXPOSE")]),t._v(" 7001\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CMD")]),t._v(" npm run start"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("prod\n")])])]),n("p",[t._v("在jenkins中构建， 选择执行shell")]),t._v(" "),n("div",{staticClass:"language-shell script extra-class"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[t._v("docker stop egg "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("  docker "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("rm")]),t._v(" egg "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("  docker rmi egg "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("  "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" /var/jenkins_home/workspace/egg  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("  docker build --rm --no-cache"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("true  -t egg "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("  docker run -d --privileged"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("true --name egg -p "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("9100")]),t._v(":7001 egg\n")])])]),n("p",[n("img",{attrs:{src:e(441),alt:"An image"}})]),t._v(" "),n("h4",{attrs:{id:"使用nginx启动vuepress博客"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#使用nginx启动vuepress博客"}},[t._v("#")]),t._v(" 使用nginx启动vuepress博客")]),t._v(" "),n("p",[t._v("在项目根目录添加Dockerfile文件")]),t._v(" "),n("div",{staticClass:"language-dockerfile extra-class"},[n("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" node"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("alpine as builder\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WORKDIR")]),t._v(" /app\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" /package.json /app/\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" npm install "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("g cnpm "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("registry=https"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//registry.npm.taobao.org\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" cnpm install\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" . /app/\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 打包")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" npm run build\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" nginx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("latest\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WORKDIR")]),t._v(" /app\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 复制到nginx镜像下")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 注意vuepress的打包目录")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("from=builder /app/docs/.vuepress/dist/ /app/ \n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 使用根项目下的nginx配置")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" nginx.conf /etc/nginx/nginx.conf\n\n")])])]),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v('user  nginx;\nworker_processes  1;\nerror_log  /var/log/nginx/error.log warn;\npid        /var/run/nginx.pid;\n\nevents {\n  worker_connections  1024;\n}\n\nhttp {\n  include       /etc/nginx/mime.types;\n  default_type  application/octet-stream;\n  log_format  main  \'$remote_addr - $remote_user [$time_local] "$request" \'\n  \'$status $body_bytes_sent "$http_referer" \'\n  \'"$http_user_agent" "$http_x_forwarded_for"\';\n  access_log  /var/log/nginx/access.log  main;\n  sendfile        on;\n  keepalive_timeout  65;\n  server {\n    listen       80;\n    location / {\n      root   /app;  # 指向目录\n      index  index.html;\n      try_files $uri $uri/ /index.html;\n    }\n    error_page   500 502 503 504  /50x.html;\n    location = /50x.html {\n      root   /usr/share/nginx/html;\n    }\n  }\n}\n\n')])])]),n("p",[t._v("在jenkins中构建， 选择执行shell")]),t._v(" "),n("div",{staticClass:"language-shell script extra-class"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[t._v("docker stop egg "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("  docker "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("rm")]),t._v(" egg "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("  docker rmi egg "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("  "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" /var/jenkins_home/workspace/egg  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("  docker build --rm --no-cache"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("true  -t egg "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("  docker run -d --privileged"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("true --name egg -p "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("9100")]),t._v(":7001 egg\n")])])]),n("p",[n("img",{attrs:{src:e(441),alt:"An image"}})])])}),[],!1,null,null,null);s.default=a.exports}}]);